<!DOCTYPE html>
<html ng-app="status">
    <head>
        <title>UPT Digital - Servers</title>
        <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
        <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-dateFormat/1.0/jquery.dateFormat.min.js"></script>
        <script src="prefs.js"></script>
        <script src="blocks.js"></script>
        <script type="text/javascript">
            var app = angular.module('status', []);
            Array.prototype.last = function(){
                return this[this.length - 1];
            };
            var a, b, today, color, found, next, temp,
                todayBlocks = blocks[$.format.date(Date(), "ddd").substr(0,3)] || [{
                    "data":"dayEmpty",
                    "start":"0:00",
                    "end":"23:59",
                    "name":"NOTHING"
                }];
            function getMinutes(str) {
                var time = str.split(':');
                return time[0]*60+time[1]*1;
            }
            function minutesNow() {
                var timeNow = new Date();
                return timeNow.getHours()*60+timeNow.getMinutes();
            }
            function setStatus(id, status, color){
                document.getElementById("s"+id).style.background = color.color;
                document.getElementById("s"+id).title = status.text;
                document.getElementById("sn"+id).innerHTML = status.code || '';
                document.getElementById("snm"+id).style.color = color.text || prefs.colors.text;
            };
            setInterval(function(){
                prefs.servers.forEach(function(val, id){
                    if(val.check){
                        val.check(val, id);
                    }else{
                        $.ajax({
                            url  : prefs.testPage+encodeURIComponent(val.url),
                            type : 'get',
                            timeout: prefs.timeout,
                            error: function(nope, err) {
                                setStatus(id, {
                                    "text":err
                                },{
                                    "color":prefs.colors.offline,
                                    "text":"#F00"
                                });
                            }

                        }).done(function(data, statusText, xhr){
                            data = JSON.parse(data);
                            switch(data.code){
                                case "ERR":
                                    setStatus(id, {
                                        "text":data.text
                                    },{
                                        "color":prefs.colors.offline,
                                        "text":"#F00"
                                    });
                                    break;

                                case 200:
                                    setStatus(id, {
                                        "text":data.text
                                    },{
                                        "color":prefs.colors.online
                                    });
                                    break;

                                default:
                                    setStatus(id, {
                                        "text":data.text,
                                        "code":data.code
                                    },{
                                        "color":prefs.colors.abnormal
                                    });
                                    break;
                            }
                        });
                    }
                })
            },prefs.checkRate);
            app.controller('ServerCtrl', function($scope){
                $scope.servers = prefs.servers;
                $scope.color = prefs.colors;
            })
            .controller('WidgetCtrl', function($scope, $interval) {
                $scope.prefs = prefs;
                function tick() {
                    $scope.clock = Date.now();
                }
                function getColor(){
                    todayBlocks.forEach(function(val, ind, arr){
                        if(getMinutes(val.start) <= minutesNow() && getMinutes(val.end) > minutesNow()){
                            if(arr[ind+1]){
                                next = arr[ind+1]
                            }else{
                                next = {
                                    "name": "Home",
                                    "start": val.end
                                }
                            }
                            $scope.color = {
                                "now":{
                                    "color": val.color,
                                    "name": val.name
                                },
                                "next":next
                            }
                            found = true;
                            return;
                        }
                    });
                    if(!found && minutesNow() < getMinutes(todayBlocks[0].start)){
                        console.log("Before and stuff");
                        $scope.color = {
                            "now":{
                                "name": "Morning"
                            },
                            "next":todayBlocks[0]
                        }
                    }else if(!found && minutesNow() >= getMinutes(todayBlocks.last().end)){
                        $scope.color = {
                            "now":{
                                "name": "Go Home"
                            },
                            "next":{
                                "disabled":true
                            }
                        }
                    }else if(!found){
                        $scope.color = {
                            "now":{
                                "name":"Error!"
                            },
                            "next":{
                                "disabled":true
                            }
                        }
                    }
                    found = false
                }
                function getTemp(){
                    $.ajax({
                        url  : prefs.temp.url,
                        error: function(nope, err, b) {
                            console.log("Unable to load temperature. Err name: "+err+". Err details: "+b);
                        }
                    }).done(function(data){
                            $scope.temp = prefs.temp.getTemp(data) || $scope.temp;
                    });
                }
                
                getColor();
                tick();
                getTemp();
                
                $interval(getTemp, 10000);
                $interval(getColor, 2000);
                $interval(tick, 100);
            });
            setTimeout(function(){
                window.location.reload();
            }, 3600000);
        </script>
        <style type="text/css">
            *{
                color: #FFF;
                position: relative
            }
            html, body{
                margin: 0;
                width: 100%;
                overflow-x: hidden;
                overflow-y: hidden;
                height: 100%;
                font-family: 'Arial', sans-serif
            }
            .wrap{
                position: absolute;
                top: -5px;
            }
            .wrap *{
                font-size: 5.5em;
            }
            #block{
                font-size: 9em;
                margin-bottom: -20px;
            }
            #time{
                font-size: 8em;
                margin-bottom: -20px;
            }
            #date{
                font-size: 4.8em;
            }
            #temp{
                font-size: 10em;
            }
            #nextBlock{
                font-size: 3em;
                left: 5px
            }
            .srv{
                top: 50px;
                left: 35%;
            }
            .ind{
                background: #F00 url(loading.svg) center no-repeat;
                background-size: 70px;
                margin: 20px;
                width: 100px;
                height: 100px;
                border-radius: 50%;
                vertical-align: middle;
                display: inline-block;
            }
            .ind span{
                top: 27px;
                font-size: 2.5em;
                text-align: center;
                display: block;
            }
            .nm{
                top: 25px;
                font-size: 5em;
            }
            .key-c{
                width: 50px;
                height: 50px;
                margin: 5px;
                vertical-align: middle;
                border-radius: 50%;
                display: inline-block;
            }
            .key-w{
                float: right;
                position: fixed;
                font-size: 1.5em;
            }
            .key{
                font-size: 2.4em;
            }
        </style>
    </head>
    <body id="body">
        <div class="wrap" ng-controller="WidgetCtrl">
            <div class="widget" id="block" ng-show="prefs.showBlock" style="color:{{color.now.color || '#FFF'}}">{{color.now.name | uppercase}}</div>
            <div class="widget" id="nextBlock" ng-show="prefs.showNextBlock && !color.next.disabled" style="color:{{color.next.color}}">Next: {{color.next.name | uppercase}} at {{color.next.start | date:'HH:mm:ss'}}</div>
            <div class="widget" id="time" ng-show="prefs.showTime" style="color:{{color}}">{{clock | date:'HH:mm:ss'}}</div>
            <div class="widget" id="date" ng-show="prefs.showDay">{{clock | date:'dd MMMM'}}</div>
            <div class="widget" id="day" ng-show="prefs.showDate">{{clock | date:'EEEE'}}</div>
            <div class="widget" id="temp" ng-show="prefs.showTemp">{{temp}}&deg;</div>
            <div class="key-w" ng-show="prefs.showKey" ng-controller="ServerCtrl">
                <div class="key">
                    <span class="key-c" style="background:{{color.online}}"></span>Online (200)
                </div>
                <div class="key">
                    <span class="key-c" style="background:{{color.abnormal}}"></span>Abnormal (!200)
                </div>
                <div class="key">
                    <span class="key-c" style="background:{{color.offline}}"></span>Offline ({{prefs.timeout/1000}}s Timeout)
                </div>
            </div>
        </div>
        <div class="ind-w" ng-controller="ServerCtrl">
            <div class="srv" ng-repeat="(num, server) in servers">
                <span class="ind" id="s{{num}}"><span id="sn{{num}}"></span></span>
                <span class="nm" id="snm{{num}}" style="color:{{(servers[num].status == 'ERR') ? color.offline : '#FFFFFF'}}">{{server.name}}</span>
            </div>
        </div>
        <script>document.getElementById("body").setAttribute("style", "background: "+prefs.colors.background);</script>
    </body>
</html>