<!DOCTYPE html>
<html ng-app="status3" ng-controller="main">
    <head>
        <title>Server Status V3.0</title>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
        <script src="/socket.io/socket.io.js"></script>
        <style>
            *{
                position: relative;
                color: #FFF;
            }
            html, body{
                min-width: 100vw;
                min-height: 100vh;
                background: #000;
                margin: 0;
                font-family: "Source Code Pro", monospace;
            }
            [ng-cloak]{
                display: none !important;
            }
            #servers-wrap{
                width: 100vw;
                text-align: center;
                top: 50vh;
                -webkit-transform: translateY(-50%);
                -moz-transform: translateY(-50%);
                -ms-transform: translateY(-50%);
                -o-transform: translateY(-50%);
                transform: translateY(-50%);
            }
            #servers{
                text-align: left;
                display: inline-block;
                font-size: 3em;
            }
            .server-icon, #notice{
                color: #F00;
            }
            .server-icon.server-ok{
                color: #0F0;
            }
            .server-icon.server-warn{
                color: #F60;
            }
            #notice{
                position: absolute;
                right: 1em;
                bottom: 1em;
                font-size: 2em;
            }
        </style>
    </head>
    <body ng-cloak>
        <div id="servers-wrap">
            <div id="servers">
                <div ng-repeat="server in servers" class="server">
                    <span class="server-icon" ng-class="{'server-ok': server.status === 200, 'server-warn': server.status !== 200 && server.status > 0}">{{server.status || "err" | uppercase}}</span>
                    <span class="server-name">{{server.name}}</span>
                </div>
            </div>
        </div>
        <div id="notice" ng-bind="notice">Loading...</div>
        <script>
            var app = angular.module('status3', []);
            app.controller('main', function($scope, $http){
                function setNotice(message, time){
                    $scope.$apply(function(scope){
                        scope.notice = message;
                    });
                    if(time){
                        setTimeout(function(){
                            $scope.$apply(function(scope){
                                scope.notice = '';
                            });
                        }, time);
                    }
                }
                function errAll(){
                    $scope.servers.forEach(function(server){
                        server.status = 'err';
                    });
                }
                $scope.notice = 'Unable to connect to API';
                $scope.servers = [];
                var socket = io();
                socket.on('connect', function(){
                    console.log("Connected to Socket");
                    setNotice('Waiting for configuration...');
                });
                socket.on('init', function(init){
                    console.log("Init Recieved: ", init);
                    setNotice('Ready!', 2000);
                    $scope.$apply(function(scope){
                        scope.servers = init.servers;
                    });
                });
                socket.on('update', function(data){
                    $scope.$apply(function(scope){
                        scope.servers[data.id] = data;
                    });
                });
                socket.on('reconnect', function(){
                    setNotice('Reconnected!', 2000);
                });
                socket.on('reconnecting', function(tryNum){
                    setNotice('Disconnected from API. (' + tryNum + ')');
                });
                socket.on('error', function(){
                    errAll();
                    setNotice('Socket Error');
                });
                socket.on('disconnect', function(){
                    errAll();
                    setNotice('Disconnected from API');
                });
            });
        </script>
    </body>
</html>