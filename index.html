<!DOCTYPE html>
<html ng-app="status3" ng-controller="main">
    <head>
        <title>Server Status V3.0</title>
        <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet">
        <script src="/socket.io/socket.io.js"></script>
        <script src="/blocks.js"></script>
        <style>
            *{
                position: relative;
                color: #FFF;
            }
            html, body{
                min-width: 100vw;
                min-height: 100vh;
                background: #000;
                -webkit-transition: background 0.5s;
                -moz-transition: background 0.5s;
                -ms-transition: background 0.5s;
                -o-transition: background 0.5s;
                transition: background 0.5s;
                margin: 0;
                font-family: "Source Code Pro", monospace;
            }
            [ng-cloak]{
                display: none !important;
            }
            #servers-wrap, #widgets-wrap{
                width: 100vw;
                text-align: center;
                top: 50vh;
                -webkit-transform: translateY(-50%);
                -moz-transform: translateY(-50%);
                -ms-transform: translateY(-50%);
                -o-transform: translateY(-50%);
                transform: translateY(-50%);
            }
            #servers, #widgets{
                text-align: left;
                display: inline-block;
                font-size: 3em;
            }
            .server-icon, #notice{
                color: #F00;
            }
            .server-icon.server-ok{
                color: #0F0;
            }
            .server-icon.server-warn{
                color: #F60;
            }
            #notice{
                position: absolute;
                right: 1em;
                bottom: 1em;
                font-size: 2em;
            }
        </style>
    </head>
    <body ng-cloak ng-style="{'background': bgCol}">
        <div id="servers-wrap" ng-hide="widgetMode">
            <div id="servers">
                <div ng-repeat="server in servers" class="server">
                    <span class="server-icon" ng-class="{'server-ok': server.status === 200, 'server-warn': server.status !== 200 && server.status > 0}">{{server.status || "err" | uppercase}}</span>
                    <span class="server-name">{{server.name}}</span>
                </div>
            </div>
        </div>
        <div id="widgets-wrap" ng-show="widgetMode">
            <div id="widgets">
                <div class="widget" ng-bind="time | date: 'hh:mm:ss'"></div>
                <div class="widget">{{block.now()}}</div>
            </div>
        </div>
        <div id="notice" ng-bind="notice">Loading...</div>
        <script>
            var OK_STATUSES = [200];
            var app = angular.module('status3', []);
            app.controller('main', function($scope, $http, $interval, $timeout){
                $scope.widgetMode = false;
                $interval(function(){
                    scope.widgetMode = !scope.widgetMode;
                }, 5000);
                $interval(function(){
                    $scope.time = new Date();
                }, 500);
                $interval(function(){
                    $scope.block = blocks.find(function(block){
                        if()
                    });
                }, 10000);
                function startAlarm(){
                    if(!$scope.alarmInterval){
                        $scope.alarmInterval = $interval(function(){
                            scope.bgCol = '#A00';
                            $timeout(function(){
                                scopeB.bgCol = '';
                            }, 1000);
                        }, 2000);
                    }
                }
                function stopAlarm(){
                    if($scope.alarmInterval){
                        clearInterval($scope.alarmInterval);
                        delete $scope.alarmInterval;
                        $scope.bgCol = '';
                    }
                }
                function setNotice(message, time){
                    $scope.$apply(function(scope){
                        scope.notice = message;
                    });
                    if(time){
                        $timeout(function(){
                            scope.notice = '';
                        }, time);
                    }
                }
                function errAll(){
                    $scope.servers.forEach(function(server){
                        server.status = 'err';
                    });
                }
                $scope.notice = 'Unable to connect to API';
                $scope.servers = [];
                var socket = io();
                socket.on('connect', function(){
                    console.log("Connected to Socket");
                    setNotice('Waiting for configuration...');
                });
                socket.on('init', function(init){
                    console.log("Init Recieved: ", init);
                    setNotice('Ready!', 2000);
                    $scope.$apply(function(scope){
                        scope.servers = init.servers;
                        if(init.servers.find(function(server){
                            return OK_STATUSES.indexOf(server.status) === -1;
                        })){
                            startAlarm();
                        }
                    });
                });
                socket.on('update', function(data){
                    $scope.$apply(function(scope){
                        scope.servers[data.id] = data;
                        if(!scope.alarmInterval && OK_STATUSES.indexOf(data.status) === -1){
                            console.log("Starting alarm");
                            startAlarm();
                        }else if(
                            !scope.servers.find(function(server){
                                return OK_STATUSES.indexOf(server.status) === -1;
                            })
                        ){
                            console.log("Stopping via update");
                            stopAlarm();
                        }
                    });
                });
                socket.on('reconnect', function(){
                    $scope.$apply(function(){
                        stopAlarm();
                    });
                    setNotice('Reconnected!', 2000);
                });
                socket.on('reconnecting', function(tryNum){
                    setNotice('Disconnected from API. (' + tryNum + ')');
                });
                socket.on('error', function(){
                    startAlarm();
                    errAll();
                    setNotice('Socket Error');
                });
                socket.on('disconnect', function(){
                    startAlarm();
                    errAll();
                    setNotice('Disconnected from API');
                });
            });
        </script>
    </body>
</html>